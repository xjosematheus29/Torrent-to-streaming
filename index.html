<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torrent Web Streamer</title>
    <!-- Incluindo Tailwind CSS para um design moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluindo a biblioteca WebTorrent -->
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <style>
        /* Estilo customizado para a barra de progresso */
        .progress-bar {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
        }
        .progress-bar::-webkit-progress-bar {
            background-color: #4a5568; /* gray-700 */
            border-radius: 4px;
        }
        .progress-bar::-webkit-progress-value {
            background-color: #4299e1; /* blue-400 */
            border-radius: 4px;
            transition: width 0.2s ease-in-out;
        }
        .progress-bar::-moz-progress-bar {
            background-color: #4299e1; /* blue-400 */
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
        <!-- Cabeçalho -->
        <header class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-400">Torrent Web Streamer</h1>
            <p class="text-gray-400 mt-2">Cole um link magnético ou info hash para começar o streaming.</p>
        </header>

        <!-- Formulário de Entrada -->
        <div class="flex flex-col sm:flex-row gap-4">
            <input type="text" id="magnet-link-input" placeholder="magnet:?xt=urn:btih:..." class="flex-grow bg-gray-700 border-2 border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
            <button id="stream-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-lg">
                Assistir
            </button>
        </div>

        <!-- Container do Vídeo -->
        <div id="video-container" class="w-full bg-black rounded-lg overflow-hidden aspect-video">
            <!-- O player de vídeo será inserido aqui -->
        </div>

        <!-- Seção de Status e Logs -->
        <div id="status-section" class="space-y-4 hidden">
            <h2 class="text-xl font-semibold border-b-2 border-gray-700 pb-2">Status do Torrent</h2>
            
            <!-- Nome do Arquivo -->
            <div id="file-name" class="text-gray-300"></div>

            <!-- Progresso -->
            <div>
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm font-medium text-gray-400">Progresso do Download</span>
                    <span id="progress-percent" class="text-sm font-medium text-blue-400">0%</span>
                </div>
                <progress id="progress-bar" value="0" max="100" class="progress-bar"></progress>
            </div>

            <!-- Estatísticas -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div class="bg-gray-700 p-3 rounded-lg">
                    <p class="text-xs text-gray-400">Peers</p>
                    <p id="peers-count" class="text-lg font-bold">0</p>
                </div>
                <div class="bg-gray-700 p-3 rounded-lg">
                    <p class="text-xs text-gray-400">Vel. Download</p>
                    <p id="download-speed" class="text-lg font-bold">0 B/s</p>
                </div>
                <div class="bg-gray-700 p-3 rounded-lg">
                    <p class="text-xs text-gray-400">Vel. Upload</p>
                    <p id="upload-speed" class="text-lg font-bold">0 B/s</p>
                </div>
                <div class="bg-gray-700 p-3 rounded-lg">
                    <p class="text-xs text-gray-400">Baixado</p>
                    <p id="downloaded" class="text-lg font-bold">0 B</p>
                </div>
            </div>
            
            <!-- Logs -->
            <div id="logs" class="bg-gray-900 rounded-lg p-4 h-32 overflow-y-auto text-sm font-mono text-gray-400">
                <p>Aguardando início do torrent...</p>
            </div>
        </div>
    </div>

    <script>
        // Selecionando os elementos do DOM
        const streamButton = document.getElementById('stream-button');
        const magnetLinkInput = document.getElementById('magnet-link-input');
        const videoContainer = document.getElementById('video-container');
        const statusSection = document.getElementById('status-section');
        
        const fileNameEl = document.getElementById('file-name');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const peersCount = document.getElementById('peers-count');
        const downloadSpeed = document.getElementById('download-speed');
        const uploadSpeed = document.getElementById('upload-speed');
        const downloaded = document.getElementById('downloaded');
        const logs = document.getElementById('logs');

        let client = null; // Variável para manter a instância do cliente

        // Função para adicionar logs na tela
        function log(message) {
            const p = document.createElement('p');
            p.textContent = `> ${message}`;
            logs.appendChild(p);
            logs.scrollTop = logs.scrollHeight; // Auto-scroll para o final
        }

        // Função para formatar bytes em KB, MB, GB, etc.
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // Adiciona o evento de clique ao botão
        streamButton.addEventListener('click', () => {
            const magnetLink = magnetLinkInput.value.trim();
            if (!magnetLink) {
                alert('Por favor, insira um link magnético ou info hash.');
                return;
            }

            // Destrói o cliente anterior se existir, para iniciar um novo torrent
            if (client) {
                client.destroy(() => {
                    log('Cliente anterior destruído. Iniciando novo torrent.');
                    startStreaming(magnetLink);
                });
            } else {
                startStreaming(magnetLink);
            }
        });
        
        function startStreaming(magnetLink) {
            // Limpa o estado anterior
            videoContainer.innerHTML = '';
            logs.innerHTML = '';
            statusSection.classList.remove('hidden');
            log('Iniciando cliente WebTorrent...');

            client = new WebTorrent();

            // Adiciona o torrent
            client.add(magnetLink, (torrent) => {
                log('Metadados do torrent recebidos. Procurando arquivo de vídeo...');
                
                // Encontra o maior arquivo de vídeo no torrent
                const file = torrent.files.reduce((a, b) => (a.length > b.length ? a : b));

                if (file) {
                    log(`Arquivo de vídeo encontrado: ${file.name}`);
                    fileNameEl.textContent = `Arquivo: ${file.name}`;

                    // Anexa o arquivo de vídeo ao container
                    file.appendTo(videoContainer, { autoplay: true, controls: true });

                    // Atualiza as estatísticas em tempo real
                    torrent.on('download', () => {
                        const progress = (torrent.progress * 100).toFixed(2);
                        progressBar.value = progress;
                        progressPercent.textContent = `${progress}%`;
                        peersCount.textContent = torrent.numPeers;
                        downloadSpeed.textContent = `${formatBytes(torrent.downloadSpeed)}/s`;
                        uploadSpeed.textContent = `${formatBytes(torrent.uploadSpeed)}/s`;
                        downloaded.textContent = formatBytes(torrent.downloaded);
                    });

                    torrent.on('done', () => {
                        log('Download completo!');
                        progressBar.value = 100;
                        progressPercent.textContent = `100%`;
                    });

                    torrent.on('warning', (err) => log(`Aviso: ${err.message}`));
                    torrent.on('error', (err) => log(`Erro: ${err.message}`));

                } else {
                    log('Nenhum arquivo de vídeo encontrado neste torrent.');
                }
            });

            client.on('error', (err) => {
                log(`Erro fatal no cliente: ${err.message}`);
                statusSection.classList.add('hidden');
                // Tenta destruir o cliente para limpar recursos
                if (client) {
                    client.destroy();
                    client = null;
                }
            });
        }
    </script>

</body>
</html>

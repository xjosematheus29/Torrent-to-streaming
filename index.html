<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebTorrent Player ‚Äì 1 arquivo</title>
  <style>
    :root{
      --bg:#0b0f14;--panel:#131a21;--panel-2:#0e151c;--text:#e8eef5;--muted:#9fb0c3;--accent:#4ac1ff;--accent-2:#22e6a1;--error:#ff5c7a;
      --radius:18px;--shadow:0 8px 30px rgba(0,0,0,.35)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 120% -10%,rgba(34,230,161,.07),transparent),linear-gradient(160deg,#0b0f14 0%,#0b0f14 35%,#0e151c 100%);color:var(--text);font:16px/1.5 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{padding:22px clamp(16px,4vw,32px);display:flex;gap:14px;align-items:center;justify-content:space-between}
    header h1{font-size:clamp(18px,2.4vw,24px);margin:0;letter-spacing:.3px}
    header .sub{color:var(--muted);font-size:.95rem}
    .wrap{max-width:1100px;margin:0 auto;padding:0 clamp(16px,4vw,32px) 48px}
    .grid{display:grid;grid-template-columns: 1.1fr .9fr;gap:20px}
    @media (max-width:960px){.grid{grid-template-columns:1fr;}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.06);backdrop-filter: blur(6px);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card h2{margin:0;padding:18px 18px 10px;font-size:1.05rem;color:#d7e6f4;letter-spacing:.2px}
    .card .content{padding:16px 18px 18px}

    /* Inputs */
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="text"]{flex:1 1 380px;background:var(--panel-2);border:1px solid rgba(255,255,255,.08);color:var(--text);padding:14px 14px;border-radius:12px;outline:none}
    input[type="text"]::placeholder{color:#8aa0b6}
    button{appearance:none;border:0;background:var(--accent);color:#00161d;padding:12px 14px;border-radius:12px;font-weight:600;cursor:pointer;transition:transform .04s ease, filter .2s ease}
    button:hover{filter:brightness(1.05)}
    button:active{transform:translateY(1px)}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.12)}
    .warning{background:var(--error);color:#29030a}

    /* Dropzone */
    .drop{margin-top:12px;border:1.5px dashed rgba(255,255,255,.18);border-radius:14px;padding:16px;background:rgba(255,255,255,.02);display:flex;align-items:center;justify-content:space-between;gap:12px}
    .drop.drag{border-color:var(--accent)}
    .drop .left{display:flex;align-items:center;gap:12px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:rgba(74,193,255,.12);color:var(--accent);padding:8px 10px;border-radius:999px;font-size:.9rem}
    .muted{color:var(--muted)}
    .k{font:600 12px/1 ui-monospace,Menlo,Consolas,monospace;background:#0a1117;border:1px solid rgba(255,255,255,.09);border-bottom-width:2px;padding:3px 6px;border-radius:8px}

    /* Player */
    .player{position:relative;overflow:hidden;border-bottom-left-radius:var(--radius);border-bottom-right-radius:var(--radius)}
    #playerContainer{aspect-ratio:16/9;background:#000;border-radius:14px;overflow:hidden;display:grid;place-items:center}
    #playerContainer video{width:100%;height:100%;object-fit:contain;background:#000}

    /* Stats */
    .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
    @media (max-width:640px){.stats{grid-template-columns:1fr}}
    .stat{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);padding:10px 12px;border-radius:12px}
    .stat .label{color:var(--muted);font-size:.82rem}
    .stat .val{font-weight:700;margin-top:4px}

    .progress{height:10px;background:rgba(255,255,255,.06);border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .3s ease}

    /* File list */
    .files{margin-top:14px;display:flex;flex-direction:column;gap:8px;max-height:240px;overflow:auto}
    .file{display:flex;align-items:center;gap:10px;justify-content:space-between;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);padding:10px 12px;border-radius:12px}
    .file .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .file .meta{color:var(--muted);font-size:.86rem}

    footer{max-width:1100px;margin:0 auto;padding:18px clamp(16px,4vw,32px) 44px;color:var(--muted)}
    a{color:var(--accent)}
  </style>
  <!-- WebTorrent (navegador) -->
  <!-- WebTorrent (browser) + fallbacks -->
<script>
(function(){
  const urls = [
    'https://cdn.jsdelivr.net/npm/webtorrent@2/dist/webtorrent.min.js',
    'https://unpkg.com/webtorrent@2/dist/webtorrent.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/webtorrent/2.3.0/webtorrent.min.js'
  ];
  function load(i){
    if(i>=urls.length){ console.error('Falha ao carregar WebTorrent de todos CDNs'); return; }
    const s = document.createElement('script');
    s.src = urls[i];
    s.defer = true;
    s.onload = ()=> console.log('WebTorrent carregado de', urls[i]);
    s.onerror = ()=>{ console.warn('CDN falhou:', urls[i]); load(i+1); };
    document.head.appendChild(s);
  }
  load(0);
})();
</script>
</head>
<body>
  <header>
    <div>
      <h1>WebTorrent Player ‚Äì tudo em um arquivo</h1>
      <div class="sub">Cole um link magnet <strong>ou</strong> envie um <code>.torrent</code> e reproduza os v√≠deos no navegador.
      </div>
    </div>
    <div class="pill" title="Aviso legal">‚öñÔ∏è Use apenas conte√∫do legal</div>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- Painel de entrada -->
      <section class="card" aria-labelledby="addTitle">
        <h2 id="addTitle">Adicionar torrent</h2>
        <div class="content">
          <div class="row">
            <input id="magnet" type="text" spellcheck="false" placeholder="Cole aqui um magnet link ou infohash (ex: magnet:?xt=urn:btih:...)"/>
            <button id="addMagnetBtn">Adicionar</button>
            <button id="clearBtn" class="ghost" title="Remover torrent atual">Limpar</button>
          </div>
          <label class="drop" id="drop">
            <div class="left">
              <span class="pill">.torrent</span>
              <div>
                <div><strong>Arraste e solte</strong> um arquivo <code>.torrent</code> aqui</div>
                <div class="muted">ou clique para escolher do seu dispositivo</div>
              </div>
            </div>
            <input id="file" type="file" accept=".torrent" hidden />
            <button type="button" class="ghost" id="pick">Selecionar</button>
          </label>
          <div style="margin-top:12px" class="muted">
            Dica: infohash puro (40 hex) tamb√©m funciona. Ex.: <span class="k">d2474e86c95b19b8bcfdb92bc12c9d44667cfa36</span>
          </div>
        </div>
      </section>

      <!-- Painel do player / estado -->
      <section class="card" aria-labelledby="playTitle">
        <h2 id="playTitle">Reprodutor</h2>
        <div class="content">
          <div id="playerContainer">üíΩ Aguardando torrent‚Ä¶</div>

          <div class="stats">
            <div class="stat"><div class="label">Progresso</div><div class="val"><div class="progress"><div class="bar" id="bar"></div></div></div></div>
            <div class="stat"><div class="label">Peers</div><div class="val" id="peers">0</div></div>
            <div class="stat"><div class="label">‚Üì Download</div><div class="val" id="down">0 B/s</div></div>
            <div class="stat"><div class="label">‚Üë Upload</div><div class="val" id="up">0 B/s</div></div>
            <div class="stat"><div class="label">Baixado</div><div class="val" id="done">0</div></div>
            <div class="stat"><div class="label">Restante</div><div class="val" id="eta">‚Äì</div></div>
          </div>

          <div class="files" id="files" aria-live="polite" aria-busy="false"></div>
          <div class="row" style="margin-top:10px;gap:8px">
            <button id="copyMagnet" class="ghost" title="Copiar magnet do torrent atual" disabled>Copiar magnet</button>
            <button id="destroy" class="warning" disabled>Parar torrent</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <footer>
    <small>
      ‚ö†Ô∏è <strong>Aviso legal:</strong> Este player √© para conte√∫do de dom√≠nio p√∫blico, com licen√ßa aberta ou que voc√™ tem direito de acessar. N√£o facilite nem participe de viola√ß√£o de direitos autorais.
      <br/>Compatibilidade: funciona em navegadores modernos via WebRTC. Prefira abrir este arquivo em <strong>localhost/HTTPS</strong> (por exemplo, com um servidor simples) para maximizar a compatibilidade de WebRTC/trackers.
    </small>
  </footer>

  <script>
    // Utilidades --------------------------------------------------------------
    const $ = (sel, root=document) => root.querySelector(sel)
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel))
    const prettyBytes = (num) => {
      if (!Number.isFinite(num) || num <= 0) return '0 B'
      const u = ['B','kB','MB','GB','TB','PB'];
      let i = 0; while (num >= 1000 && i < u.length-1) { num/=1000; i++ }
      const dec = (num < 10 && i>0) ? 1 : 0
      return num.toFixed(dec) + ' ' + u[i]
    }
    const prettyTime = (sec) => {
      if (!Number.isFinite(sec) || sec<=0) return '‚Äî'
      const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s=Math.floor(sec%60)
      return [h, m, s].map((v,i)=> i===0 && v===0 ? null : String(v).padStart(2,'0')).filter(Boolean).join(':')
    }
    const isInfoHash = (txt) => /^[a-fA-F0-9]{40}$/.test(txt) || /^[A-Z2-7]{32}$/i.test(txt)
    const toMagnet = (hash) => `magnet:?xt=urn:btih:${hash}`

    // Trackers WebRTC com suporte a WSS (lista pode variar ao longo do tempo)
    const DEFAULT_TRACKERS = [
      'wss://tracker.openwebtorrent.com',
      'wss://tracker.fastcast.nz',
      'wss://tracker.webtorrent.dev'
    ]

    // Cliente WebTorrent ------------------------------------------------------
    let client, activeTorrent=null, statsTimer=null
    async function ensureClient(){
  if (client) return client
  // Aguarda a lib WebTorrent carregar (at√© 10s)
  const wait = (ms)=> new Promise(r=>setTimeout(r,ms))
  const start = Date.now()
  while (!window.WebTorrent && (Date.now() - start) < 10000) { await wait(100) }
  if (!window.WebTorrent){
    alert('Falha ao carregar WebTorrent. Verifique bloqueadores (uBlock/AdGuard), rede corporativa, e se abriu via HTTPS/localhost. Recarregue a p√°gina.')
    throw new Error('WebTorrent n√£o dispon√≠vel')
  }
  client = new WebTorrent({
    tracker: {
      rtcConfig: {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:global.stun.twilio.com:3478?transport=udp' }
        ]
      }
    }
  })
  return client
}

    // UI refs ----------------------------------------------------------------
    const magnetInput = $('#magnet')
    const addMagnetBtn = $('#addMagnetBtn')
    const clearBtn = $('#clearBtn')
    const drop = $('#drop')
    const filePicker = $('#file')
    const pickBtn = $('#pick')
    const playerContainer = $('#playerContainer')
    const filesEl = $('#files')
    const bar = $('#bar')
    const peers = $('#peers')
    const down = $('#down')
    const up = $('#up')
    const done = $('#done')
    const eta = $('#eta')
    const copyMagnetBtn = $('#copyMagnet')
    const destroyBtn = $('#destroy')

    // A√ß√µes ------------------------------------------------------------------
    async function addFromMagnet(){
      let uri = magnetInput.value.trim()
      if (!uri) return
      if (isInfoHash(uri)) uri = toMagnet(uri)
      startTorrent(uri)
    }

    async function addFromFile(file){
      if (!file) return
      startTorrent(file, { announce: DEFAULT_TRACKERS })
    }

    async function startTorrent(source, opts={}){
      const c = await ensureClient()
      // Se j√° existe, limpa anterior
      if (activeTorrent) {
        activeTorrent.destroy({ destroyStore: false })
        activeTorrent = null
      }
      filesEl.innerHTML = ''
      playerContainer.innerHTML = '‚è≥ Conectando‚Ä¶'
      copyMagnetBtn.disabled = true
      destroyBtn.disabled = true

      const addOpts = Object.assign({ announce: DEFAULT_TRACKERS }, opts)
      try{
        activeTorrent = c.add(source, addOpts, onReady)
        bindStats(activeTorrent)
      }catch(err){
        console.error(err)
        playerContainer.innerHTML = '<span style="color:var(--error)">Erro ao adicionar torrent.</span>'
      }
    }

    function onReady(torrent){
      destroyBtn.disabled = false
      copyMagnetBtn.disabled = false
      playerContainer.innerHTML = 'üìÅ Selecione um arquivo para reproduzir'
      // Lista de arquivos: prioriza v√≠deos e o maior primeiro
      const videoRe = /\.(mp4|m4v|webm|ogv|mov|mkv|mp3|m4a|ogg|wav|flac)$/i
      const files = [...torrent.files].sort((a,b)=> b.length - a.length)
      const vids = files.filter(f=>videoRe.test(f.name))
      renderFileList(files, videoRe)
      // Se houver v√≠deo, escolhe o maior automaticamente
      if (vids.length){ selectFile(vids[0], torrent) }
    }

    function renderFileList(files, videoRe){
      filesEl.innerHTML = ''
      files.forEach((f, idx)=>{
        const row = document.createElement('div')
        row.className = 'file'
        const left = document.createElement('div')
        left.style.display='flex'; left.style.gap='10px'; left.style.alignItems='center'
        const badge = document.createElement('span')
        badge.className='pill'
        badge.style.background = videoRe.test(f.name) ? 'rgba(34,230,161,.12)' : 'rgba(74,193,255,.12)'
        badge.style.color = videoRe.test(f.name) ? 'var(--accent-2)' : 'var(--accent)'
        badge.textContent = videoRe.test(f.name) ? 'm√≠dia' : 'arquivo'
        const name = document.createElement('div')
        name.className='name'; name.innerText = f.name
        const meta = document.createElement('div')
        meta.className='meta'; meta.innerText = prettyBytes(f.length)
        const play = document.createElement('button')
        play.textContent = videoRe.test(f.name) ? 'Reproduzir' : 'Baixar'
        play.className = videoRe.test(f.name) ? '' : 'ghost'
        play.addEventListener('click', ()=>{
          if (videoRe.test(f.name)) selectFile(f) 
          else downloadFile(f)
        })
        left.append(badge, name)
        row.append(left, meta, play)
        filesEl.appendChild(row)
      })
    }

    function selectFile(file){
      // Limpa player e renderiza o arquivo de m√≠dia
      playerContainer.innerHTML = ''
      try{
        file.appendTo(playerContainer, { autoplay: true }, (err, el)=>{
          if (err){
            playerContainer.innerHTML = '<span style="color:var(--error)">Falha ao reproduzir este arquivo no seu navegador.</span>'
            console.error(err)
          }else{
            if (el && el.tagName === 'VIDEO'){
              el.setAttribute('controls','')
              el.setAttribute('playsinline','')
            }
          }
        })
      }catch(e){
        console.error(e)
        playerContainer.innerHTML = '<span style="color:var(--error)">Erro ao preparar o player.</span>'
      }
    }

    function downloadFile(file){
      file.getBlobURL((err, url)=>{
        if (err) return alert('Erro ao obter arquivo: '+err.message)
        const a = document.createElement('a')
        a.href = url; a.download = file.name; a.click()
        URL.revokeObjectURL(url)
      })
    }

    function bindStats(torrent){
      if (statsTimer) clearInterval(statsTimer)
      const update = ()=>{
        const prog = Math.max(0, Math.min(1, torrent.progress || 0))
        bar.style.width = (prog*100).toFixed(2)+'%'
        peers.textContent = String(torrent.numPeers || 0)
        down.textContent = prettyBytes(torrent.downloadSpeed || 0) + '/s'
        up.textContent = prettyBytes(torrent.uploadSpeed || 0) + '/s'
        done.textContent = prettyBytes(torrent.downloaded || 0)
        eta.textContent = torrent.done ? 'Conclu√≠do' : prettyTime((torrent.timeRemaining||0)/1000)
      }
      update()
      statsTimer = setInterval(update, 500)

      torrent.on('download', update)
      torrent.on('upload', update)
      torrent.on('wire', update)
      torrent.on('error', (err)=>{
        console.error('Torrent error', err)
        playerContainer.innerHTML = '<span style="color:var(--error)">Erro no torrent: '+(err?.message||err)+'</span>'
      })
      torrent.on('done', ()=>{
        update();
      })
    }

    // Eventos UI --------------------------------------------------------------
    addMagnetBtn.addEventListener('click', addFromMagnet)
    magnetInput.addEventListener('keydown', e=>{ if (e.key==='Enter') addFromMagnet() })
    clearBtn.addEventListener('click', ()=>{
      magnetInput.value = ''
      filesEl.innerHTML = ''
      bar.style.width = '0%'
      peers.textContent = down.textContent = up.textContent = '0'
      done.textContent = '0'
      eta.textContent = '‚Äî'
      copyMagnetBtn.disabled = true
      destroyBtn.disabled = true
      playerContainer.innerHTML = 'üíΩ Aguardando torrent‚Ä¶'
      if (activeTorrent){ activeTorrent.destroy({ destroyStore:false }); activeTorrent=null }
    })

    pickBtn.addEventListener('click', ()=> filePicker.click())
    drop.addEventListener('click', (e)=>{
      if (e.target === pickBtn) return
      filePicker.click()
    })
    filePicker.addEventListener('change', ()=>{
      const f = filePicker.files?.[0]; if (f) addFromFile(f)
      filePicker.value = ''
    })

    ;['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{e.preventDefault();e.stopPropagation(); drop.classList.add('drag')}))
    ;['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{e.preventDefault();e.stopPropagation(); drop.classList.remove('drag')}))
    drop.addEventListener('drop', (e)=>{
      const f = e.dataTransfer?.files?.[0]; if (f && f.name.endsWith('.torrent')) addFromFile(f)
    })

    copyMagnetBtn.addEventListener('click', async ()=>{
      try{
        if (!activeTorrent) return
        const uri = activeTorrent.magnetURI
        await navigator.clipboard.writeText(uri)
        copyMagnetBtn.textContent = 'Copiado!'
        setTimeout(()=> copyMagnetBtn.textContent = 'Copiar magnet', 1500)
      }catch{ alert('N√£o foi poss√≠vel copiar automaticamente. Copie manualmente: '+activeTorrent.magnetURI) }
    })

    destroyBtn.addEventListener('click', ()=>{
      if (!activeTorrent) return
      destroyBtn.disabled = true
      activeTorrent.destroy({ destroyStore:false }, ()=>{
        playerContainer.innerHTML = 'üõë Torrent parado.'
      })
    })

    // Qualquer erro global
    window.addEventListener('error', (e)=> console.warn('Erro:', e.message))
  </script>
</body>
</html>
